<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>Chevre Domain Library for Node.js Source: service/event.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.cosmo.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top navbar-inverse">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">Chevre Domain Library for Node.js</a>
		<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
        </button>
	</div>
	<div class="navbar-collapse collapse" id="topNavigation">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="Distributions.html">Distributions</a></li><li><a href="MongoRepository.html">MongoRepository</a></li><li><a href="RedisRepository.html">RedisRepository</a></li><li><a href="Repository.html">Repository</a></li><li><a href="Subject.html">Subject</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="global.html#abort">abort</a></li><li><a href="global.html#accountTitle_1">accountTitle_1</a></li><li><a href="global.html#aggregateScreeningEvent">aggregateScreeningEvent</a></li><li><a href="global.html#AggregationService">AggregationService</a></li><li><a href="global.html#call">call</a></li><li><a href="global.html#cancel">cancel</a></li><li><a href="global.html#cancelPendingReservation">cancelPendingReservation</a></li><li><a href="global.html#cancelReservation">cancelReservation</a></li><li><a href="global.html#COA">COA</a></li><li><a href="global.html#confirm">confirm</a></li><li><a href="global.html#confirmReservation">confirmReservation</a></li><li><a href="global.html#countTicketTypePerEvent">countTicketTypePerEvent</a></li><li><a href="global.html#create">create</a></li><li><a href="global.html#createDebug">createDebug</a></li><li><a href="global.html#createScreeningEventIdFromCOA">createScreeningEventIdFromCOA</a></li><li><a href="global.html#default">default</a></li><li><a href="global.html#execute">execute</a></li><li><a href="global.html#executeByName">executeByName</a></li><li><a href="global.html#exportTasks">exportTasks</a></li><li><a href="global.html#exportTasksById">exportTasksById</a></li><li><a href="global.html#importFromCOA">importFromCOA</a></li><li><a href="global.html#importMovieTheaterFromCOA">importMovieTheaterFromCOA</a></li><li><a href="global.html#matchWithXML">matchWithXML</a></li><li><a href="global.html#redis">redis</a></li><li><a href="global.html#retry">retry</a></li><li><a href="global.html#schema">schema</a></li><li><a href="global.html#searchScreeningEventTicketOffers">searchScreeningEventTicketOffers</a></li><li><a href="global.html#sortOrder4executionOfTasks">sortOrder4executionOfTasks</a></li><li><a href="global.html#start">start</a></li>
				</ul>
			</li>
			
		</ul>
        
            <div class="col-sm-3 col-md-3">
                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search" name="q" id="search-input">
                        <div class="input-group-btn">
                            <button class="btn btn-default" id="search-submit"><i class="glyphicon glyphicon-search"></i></button>
                        </div>
                    </div>
                </form>
            </div>
        
	</div>

</div>
</div>


<div class="container" id="toc-content">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			

		<h1 class="page-title">Source: service/event.js</h1>
    
<section>
    <article>
        <pre
            class="sunlight-highlight-javascript linenums">"use strict";
var __awaiter = (this &amp;&amp; this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * イベントサービス
 */
const COA = require("@motionpicture/coa-service");
const createDebug = require("debug");
const google_libphonenumber_1 = require("google-libphonenumber");
// @ts-ignore
const difference = require("lodash.difference");
const moment = require("moment-timezone");
const factory = require("../factory");
const debug = createDebug('cinerino-domain:service');
/**
 * 映画作品インポート
 */
// export function importMovies(theaterCode: string) {
//     return async (repos: { creativeWork: CreativeWorkRepo }) => {
//         // COAから作品取得
//         const filmsFromCOA = await COA.services.master.title({ theaterCode: theaterCode });
//         // 永続化
//         await Promise.all(filmsFromCOA.map(async (filmFromCOA) => {
//             const movie = createMovieFromCOA(filmFromCOA);
//             debug('storing movie...', movie);
//             await repos.creativeWork.saveMovie(movie);
//             debug('movie stored.');
//         }));
//     };
// }
// tslint:disable-next-line:no-single-line-block-comment
/* istanbul ignore next */
// function createMovieFromCOA(filmFromCOA: COA.services.master.ITitleResult): factory.chevre.creativeWork.movie.ICreativeWork {
//     return {
//         identifier: filmFromCOA.titleCode,
//         name: filmFromCOA.titleNameOrig,
//         duration: moment.duration(filmFromCOA.showTime, 'm').toISOString(),
//         contentRating: filmFromCOA.kbnEirin,
//         typeOf: factory.creativeWorkType.Movie
//     };
// }
/**
 * XMLに存在するスケジュールかどうかを判定する
 */
function matchWithXML(xmlSchedules, coaSchedule) {
    return xmlSchedules.some((xmlSchedule) => {
        return xmlSchedule.some((schedule) => {
            return schedule.date === coaSchedule.dateJouei
                &amp;&amp; schedule.movie.some((movie) => {
                    return movie.movieShortCode === coaSchedule.titleCode
                        &amp;&amp; movie.screen.some((screen) => {
                            return screen.screenCode === coaSchedule.screenCode
                                &amp;&amp; screen.time.some((time) => time.startTime === coaSchedule.timeBegin &amp;&amp; time.endTime === coaSchedule.timeEnd);
                        });
                });
        });
    });
}
exports.matchWithXML = matchWithXML;
/**
 * イベントをインポートする
 */
function importFromCOA(params) {
    // tslint:disable-next-line:max-func-body-length
    return (repos) => __awaiter(this, void 0, void 0, function* () {
        const movieTheater = yield importMovieTheaterFromCOA({ theaterCode: params.locationBranchCode })(repos);
        const place = yield repos.place.findMovieTheaterByBranchCode({
            branchCode: params.locationBranchCode
        });
        let xmlEndPoint;
        // tslint:disable-next-line:no-single-line-block-comment
        /* istanbul ignore else */
        if (Array.isArray(place.additionalProperty)) {
            const xmlEndPointProperty = place.additionalProperty.find(((p) => {
                return p.name === 'xmlEndPoint';
            }));
            xmlEndPoint = (xmlEndPointProperty !== undefined) ? JSON.parse(xmlEndPointProperty.value) : undefined;
        }
        // COAから作品取得
        const filmsFromCOA = yield COA.services.master.title({
            theaterCode: params.locationBranchCode
        });
        const targetImportFrom = moment(`${moment(params.importFrom)
            .tz('Asia/Tokyo')
            .format('YYYY-MM-DD')}T00:00:00+09:00`);
        const targetImportThrough = moment(`${moment(params.importThrough)
            .tz('Asia/Tokyo')
            .format('YYYY-MM-DD')}T00:00:00+09:00`)
            .add(1, 'day');
        debug('importing screening events...', targetImportFrom, targetImportThrough);
        // COAから上映イベント取得
        debug('finding schedules from COA...', moment(targetImportFrom)
            .tz('Asia/Tokyo')
            .format('YYYYMMDD'), moment(targetImportThrough)
            .add(-1, 'day')
            .tz('Asia/Tokyo')
            .format('YYYYMMDD'));
        const schedulesFromCOA = yield COA.services.master.schedule({
            theaterCode: params.locationBranchCode,
            begin: moment(targetImportFrom)
                .tz('Asia/Tokyo')
                .format('YYYYMMDD'),
            end: moment(targetImportThrough)
                .add(-1, 'day')
                .tz('Asia/Tokyo')
                .format('YYYYMMDD') // COAは日本時間で判断
        });
        let schedulesFromXML = [];
        if (xmlEndPoint !== undefined) {
            try {
                debug('finding xmlSchedule...', xmlEndPoint.theaterCodeName);
                schedulesFromXML = yield COA.services.master.xmlSchedule({
                    baseUrl: xmlEndPoint.baseUrl,
                    theaterCodeName: xmlEndPoint.theaterCodeName
                });
            }
            catch (err) {
                // tslint:disable-next-line:no-console
                console.error(err);
            }
        }
        // xmlEndPointがない場合、処理を続きます
        if (xmlEndPoint === undefined || schedulesFromXML.length > 0) {
            // COAから区分マスター抽出
            const serviceKubuns = yield COA.services.master.kubunName({
                theaterCode: params.locationBranchCode,
                kubunClass: '009'
            });
            const acousticKubuns = yield COA.services.master.kubunName({
                theaterCode: params.locationBranchCode,
                kubunClass: '046'
            });
            const eirinKubuns = yield COA.services.master.kubunName({
                theaterCode: params.locationBranchCode,
                kubunClass: '044'
            });
            const eizouKubuns = yield COA.services.master.kubunName({
                theaterCode: params.locationBranchCode,
                kubunClass: '042'
            });
            const joueihousikiKubuns = yield COA.services.master.kubunName({
                theaterCode: params.locationBranchCode,
                kubunClass: '045'
            });
            const jimakufukikaeKubuns = yield COA.services.master.kubunName({
                theaterCode: params.locationBranchCode,
                kubunClass: '043'
            });
            debug('kubunNames found.');
            // 永続化
            const screeningEventSerieses = yield Promise.all(filmsFromCOA.map((filmFromCOA) => __awaiter(this, void 0, void 0, function* () {
                const screeningEventSeries = createScreeningEventSeriesFromCOA({
                    filmFromCOA: filmFromCOA,
                    movieTheater: movieTheater,
                    eirinKubuns: eirinKubuns,
                    eizouKubuns: eizouKubuns,
                    joueihousikiKubuns: joueihousikiKubuns,
                    jimakufukikaeKubuns: jimakufukikaeKubuns
                });
                yield repos.event.save({
                    id: screeningEventSeries.id,
                    attributes: screeningEventSeries,
                    upsert: true
                });
                const additionalProperty = {
                    name: 'coaInfo',
                    value: JSON.stringify(screeningEventSeries.coaInfo)
                };
                yield repos.event.eventModel.findByIdAndUpdate(screeningEventSeries.id, {
                    $pull: {
                        additionalProperty: { name: additionalProperty.name }
                    }
                })
                    .exec();
                const doc = yield repos.event.eventModel.findByIdAndUpdate(screeningEventSeries.id, {
                    $push: {
                        additionalProperty: {
                            $each: [additionalProperty],
                            $position: 0
                        }
                    }
                }, { new: true })
                    .exec();
                if (doc === null) {
                    throw new factory.errors.NotFound('Event');
                }
                return doc.toObject();
            })));
            // 上映イベントごとに永続化トライ
            const screeningEvents = [];
            schedulesFromCOA.forEach((scheduleFromCOA) => {
                if (xmlEndPoint === undefined || matchWithXML(schedulesFromXML, scheduleFromCOA)) {
                    const screeningEventSeriesId = createScreeningEventSeriesId({
                        theaterCode: params.locationBranchCode,
                        titleCode: scheduleFromCOA.titleCode,
                        titleBranchNum: scheduleFromCOA.titleBranchNum
                    });
                    // スクリーン存在チェック
                    const screenRoom = movieTheater.containsPlace.find((p) => p.branchCode === scheduleFromCOA.screenCode);
                    if (screenRoom === undefined) {
                        // tslint:disable-next-line:no-console
                        console.error('screenRoom not found.', scheduleFromCOA.screenCode);
                        return;
                    }
                    // 上映イベントシリーズ取得
                    const screeningEventSeries = screeningEventSerieses.find((e) => e.id === screeningEventSeriesId);
                    if (screeningEventSeries === undefined) {
                        // tslint:disable-next-line:no-console
                        console.error('screeningEventSeries not found.', screeningEventSeriesId);
                        return;
                    }
                    // 永続化
                    const screeningEvent = createScreeningEventFromCOA({
                        performanceFromCOA: scheduleFromCOA,
                        screenRoom: screenRoom,
                        superEvent: screeningEventSeries,
                        serviceKubuns: serviceKubuns,
                        acousticKubuns: acousticKubuns
                    });
                    screeningEvents.push(screeningEvent);
                }
            });
            debug(`storing ${screeningEvents.length} screeningEvents...`);
            yield Promise.all(screeningEvents.map((screeningEvent) => __awaiter(this, void 0, void 0, function* () {
                try {
                    yield repos.event.save({
                        id: screeningEvent.id,
                        attributes: screeningEvent,
                        upsert: true
                    });
                    const additionalProperty = {
                        name: 'coaInfo',
                        value: JSON.stringify(screeningEvent.coaInfo)
                    };
                    yield repos.event.eventModel.findByIdAndUpdate(screeningEvent.id, {
                        $pull: {
                            additionalProperty: { name: additionalProperty.name }
                        }
                    })
                        .exec();
                    yield repos.event.eventModel.findByIdAndUpdate(screeningEvent.id, {
                        $push: {
                            additionalProperty: {
                                $each: [additionalProperty],
                                $position: 0
                            }
                        }
                    })
                        .exec();
                }
                catch (error) {
                    // tslint:disable-next-line:no-single-line-block-comment
                    /* istanbul ignore next */
                    // tslint:disable-next-line:no-console
                    console.error(error);
                }
            })));
            debug(`${screeningEvents.length} screeningEvents stored.`);
            // COAから削除されたイベントをキャンセル済ステータスへ変更
            const ids = yield repos.event.search({
                typeOf: factory.eventType.ScreeningEvent,
                superEvent: {
                    locationBranchCodes: [params.locationBranchCode]
                },
                startFrom: targetImportFrom.toDate(),
                startThrough: targetImportThrough.toDate()
            })
                .then((events) => events.map((e) => e.id));
            const idsShouldBe = screeningEvents.map((e) => e.id);
            const cancelledIds = difference(ids, idsShouldBe);
            debug(`cancelling ${cancelledIds.length} events...`);
            yield Promise.all(cancelledIds.map((id) => __awaiter(this, void 0, void 0, function* () {
                try {
                    yield repos.event.cancel({ id });
                }
                catch (error) {
                    // tslint:disable-next-line:no-single-line-block-comment
                    /* istanbul ignore next */
                    // tslint:disable-next-line:no-console
                    console.error(error);
                }
            })));
            debug(`${cancelledIds.length} events cancelled.`);
        }
    });
}
exports.importFromCOA = importFromCOA;
/**
 * 劇場インポート
 */
function importMovieTheaterFromCOA(params) {
    return (repos) => __awaiter(this, void 0, void 0, function* () {
        const movieTheater = createMovieTheaterFromCOA(yield COA.services.master.theater({ theaterCode: params.theaterCode }), yield COA.services.master.screen({ theaterCode: params.theaterCode }));
        // 場所を保管
        debug('storing movieTheater...', movieTheater);
        yield repos.place.saveMovieTheater(movieTheater);
        debug('movieTheater stored.');
        return movieTheater;
    });
}
exports.importMovieTheaterFromCOA = importMovieTheaterFromCOA;
/**
 * コアデータから上映イベントを作成する
 */
// tslint:disable-next-line:no-single-line-block-comment
/* istanbul ignore next */
// tslint:disable-next-line:max-func-body-length
function createScreeningEventFromCOA(params) {
    const id = createScreeningEventIdFromCOA({
        theaterCode: params.superEvent.location.branchCode,
        titleCode: params.superEvent.workPerformed.identifier,
        titleBranchNum: params.performanceFromCOA.titleBranchNum,
        dateJouei: params.performanceFromCOA.dateJouei,
        screenCode: params.performanceFromCOA.screenCode,
        timeBegin: params.performanceFromCOA.timeBegin
    });
    // COA情報を整形して開始日時と終了日時を作成('2500'のような日またぎの時刻入力に対応)
    let timeEnd = params.performanceFromCOA.timeEnd;
    let addDay = 0;
    try {
        const DAY = 2400;
        addDay += Math.floor(Number(timeEnd) / DAY);
        // tslint:disable-next-line:no-magic-numbers
        timeEnd = `0000${Number(timeEnd) % DAY}`.slice(-4);
    }
    catch (error) {
        // no op
    }
    let endDate = moment(`${params.performanceFromCOA.dateJouei} ${timeEnd} +09:00`, 'YYYYMMDD HHmm Z')
        .add(addDay, 'days')
        .toDate();
    const startDate = moment(`${params.performanceFromCOA.dateJouei} ${params.performanceFromCOA.timeBegin} +09:00`, 'YYYYMMDD HHmm Z')
        .toDate();
    // startDateの方が大きければ日またぎイベントなので調整
    // tslint:disable-next-line:no-single-line-block-comment
    /* istanbul ignore if */
    if (moment(startDate)
        .isAfter(moment(endDate))) {
        endDate = moment(endDate)
            .add(1, 'day')
            .toDate();
    }
    const validFrom = moment(`${params.performanceFromCOA.rsvStartDate} 00:00:00+09:00`, 'YYYYMMDD HH:mm:ssZ')
        .toDate();
    const validThrough = moment(`${params.performanceFromCOA.rsvEndDate} 00:00:00+09:00`, 'YYYYMMDD HH:mm:ssZ')
        .add(1, 'day')
        .toDate();
    const coaInfo = {
        theaterCode: params.superEvent.location.branchCode,
        dateJouei: params.performanceFromCOA.dateJouei,
        titleCode: params.performanceFromCOA.titleCode,
        titleBranchNum: params.performanceFromCOA.titleBranchNum,
        timeBegin: params.performanceFromCOA.timeBegin,
        timeEnd: params.performanceFromCOA.timeEnd,
        screenCode: params.performanceFromCOA.screenCode,
        trailerTime: params.performanceFromCOA.trailerTime,
        kbnService: params.serviceKubuns.filter((kubun) => kubun.kubunCode === params.performanceFromCOA.kbnService)[0],
        kbnAcoustic: params.acousticKubuns.filter((kubun) => kubun.kubunCode === params.performanceFromCOA.kbnAcoustic)[0],
        nameServiceDay: params.performanceFromCOA.nameServiceDay,
        availableNum: params.performanceFromCOA.availableNum,
        rsvStartDate: params.performanceFromCOA.rsvStartDate,
        rsvEndDate: params.performanceFromCOA.rsvEndDate,
        flgEarlyBooking: params.performanceFromCOA.flgEarlyBooking
    };
    // const acceptedPaymentMethod: factory.paymentMethodType[] | undefined =
    //     (params.screeningEventSeries.offers !== undefined) ? params.screeningEventSeries.offers.acceptedPaymentMethod : undefined;
    const offers = {
        id: '',
        name: {
            ja: '',
            en: ''
        },
        typeOf: 'Offer',
        priceCurrency: factory.priceCurrency.JPY,
        // acceptedPaymentMethod: acceptedPaymentMethod,
        availabilityEnds: validThrough,
        availabilityStarts: validFrom,
        validFrom: validFrom,
        validThrough: validThrough,
        eligibleQuantity: {
            maxValue: params.performanceFromCOA.availableNum,
            unitCode: factory.unitCode.C62,
            typeOf: 'QuantitativeValue'
        },
        itemOffered: {
            serviceType: {
                typeOf: 'ServiceType',
                id: '',
                name: ''
            }
        }
        // offeredThrough: {
        //     typeOf: 'WebAPI',
        //     identifier: factory.service.webAPI.Identifier.COA
        // }
    };
    return {
        typeOf: factory.eventType.ScreeningEvent,
        id: id,
        identifier: id,
        name: params.superEvent.name,
        eventStatus: factory.eventStatusType.EventScheduled,
        workPerformed: params.superEvent.workPerformed,
        location: {
            typeOf: params.screenRoom.typeOf,
            branchCode: params.screenRoom.branchCode,
            name: params.screenRoom.name
        },
        endDate: endDate,
        startDate: startDate,
        superEvent: params.superEvent,
        coaInfo: coaInfo,
        offers: offers,
        checkInCount: 0,
        attendeeCount: 0,
        maximumAttendeeCapacity: params.screenRoom.maximumAttendeeCapacity,
        remainingAttendeeCapacity: params.screenRoom.maximumAttendeeCapacity
        // additionalProperty: [
        //     {
        //         name: 'COA_ENDPOINT',
        //         value: &lt;string>process.env.COA_ENDPOINT
        //     },
        //     {
        //         name: 'coaInfo',
        //         value: JSON.stringify(coaInfo)
        //     }
        // ]
    };
}
exports.createScreeningEventFromCOA = createScreeningEventFromCOA;
/**
 * COAの作品抽出結果からFilmオブジェクトを作成する
 */
// tslint:disable-next-line:no-single-line-block-comment
/* istanbul ignore next */
function createScreeningEventSeriesFromCOA(params) {
    const endDate = (moment(`${params.filmFromCOA.dateEnd} +09:00`, 'YYYYMMDD Z')
        .isValid())
        ? moment(`${params.filmFromCOA.dateEnd} +09:00`, 'YYYYMMDD Z')
            .toDate()
        : undefined;
    const startDate = (moment(`${params.filmFromCOA.dateBegin} +09:00`, 'YYYYMMDD Z')
        .isValid())
        ? moment(`${params.filmFromCOA.dateBegin} +09:00`, 'YYYYMMDD Z')
            .toDate()
        : undefined;
    // title_codeは劇場をまたいで共有、title_branch_numは劇場毎に管理
    const id = createScreeningEventSeriesId({
        theaterCode: params.movieTheater.branchCode,
        titleCode: params.filmFromCOA.titleCode,
        titleBranchNum: params.filmFromCOA.titleBranchNum
    });
    const coaInfo = {
        titleBranchNum: params.filmFromCOA.titleBranchNum,
        kbnEirin: params.eirinKubuns.filter((k) => k.kubunCode === params.filmFromCOA.kbnEirin)[0],
        kbnEizou: params.eizouKubuns.filter((k) => k.kubunCode === params.filmFromCOA.kbnEizou)[0],
        kbnJoueihousiki: params.joueihousikiKubuns.filter((k) => k.kubunCode === params.filmFromCOA.kbnJoueihousiki)[0],
        kbnJimakufukikae: params.jimakufukikaeKubuns.filter((k) => k.kubunCode === params.filmFromCOA.kbnJimakufukikae)[0],
        flgMvtkUse: params.filmFromCOA.flgMvtkUse,
        dateMvtkBegin: params.filmFromCOA.dateMvtkBegin
    };
    const acceptedPaymentMethod = [
        factory.paymentMethodType.Account,
        factory.paymentMethodType.Cash,
        factory.paymentMethodType.CreditCard,
        factory.paymentMethodType.EMoney
    ];
    if (coaInfo.flgMvtkUse === '1') {
        acceptedPaymentMethod.push(factory.paymentMethodType.MovieTicket);
    }
    return {
        typeOf: factory.eventType.ScreeningEventSeries,
        eventStatus: factory.eventStatusType.EventScheduled,
        id: id,
        identifier: id,
        name: {
            ja: params.filmFromCOA.titleName,
            en: params.filmFromCOA.titleNameEng
        },
        kanaName: params.filmFromCOA.titleNameKana,
        alternativeHeadline: params.filmFromCOA.titleNameShort,
        location: {
            id: (params.movieTheater.id !== undefined) ? params.movieTheater.id : '',
            branchCode: params.movieTheater.branchCode,
            name: params.movieTheater.name,
            kanaName: params.movieTheater.kanaName,
            typeOf: params.movieTheater.typeOf
        },
        organizer: {
            typeOf: factory.organizationType.MovieTheater,
            identifier: params.movieTheater.id,
            name: params.movieTheater.name
        },
        videoFormat: params.eizouKubuns.filter((kubun) => kubun.kubunCode === params.filmFromCOA.kbnEizou)[0],
        soundFormat: [],
        workPerformed: {
            identifier: params.filmFromCOA.titleCode,
            name: params.filmFromCOA.titleNameOrig,
            duration: moment.duration(params.filmFromCOA.showTime, 'm')
                .toISOString(),
            contentRating: params.eirinKubuns.filter((kubun) => kubun.kubunCode === params.filmFromCOA.kbnEirin)[0],
            typeOf: factory.creativeWorkType.Movie
        },
        duration: moment.duration(params.filmFromCOA.showTime, 'm')
            .toISOString(),
        endDate: endDate,
        startDate: startDate,
        coaInfo: coaInfo,
        offers: {
            typeOf: 'Offer',
            priceCurrency: factory.priceCurrency.JPY,
            acceptedPaymentMethod: acceptedPaymentMethod
        }
        // additionalProperty: [
        //     {
        //         name: 'COA_ENDPOINT',
        //         value: &lt;string>process.env.COA_ENDPOINT
        //     },
        //     {
        //         name: 'coaInfo',
        //         value: JSON.stringify(coaInfo)
        //     }
        // ]
    };
}
exports.createScreeningEventSeriesFromCOA = createScreeningEventSeriesFromCOA;
/**
 * COA情報から上映イベントIDを作成する
 */
function createScreeningEventIdFromCOA(params) {
    return [
        createScreeningEventSeriesId(params),
        params.dateJouei,
        params.screenCode,
        params.timeBegin
    ].join('');
}
exports.createScreeningEventIdFromCOA = createScreeningEventIdFromCOA;
/**
 * COA情報から上映イベント識別子を作成する
 */
// tslint:disable-next-line:no-single-line-block-comment
/* istanbul ignore next */
function createScreeningEventSeriesId(params) {
    return [
        params.theaterCode,
        params.titleCode,
        params.titleBranchNum
    ].join('');
}
exports.createScreeningEventSeriesId = createScreeningEventSeriesId;
/**
 * コアマスター抽出結果から作成する
 */
// tslint:disable-next-line:no-single-line-block-comment
/* istanbul ignore next */
function createMovieTheaterFromCOA(theaterFromCOA, screensFromCOA) {
    // 日本語フォーマットで電話番号が提供される想定なので変換
    let formatedPhoneNumber;
    try {
        const phoneUtil = google_libphonenumber_1.PhoneNumberUtil.getInstance();
        const phoneNumber = phoneUtil.parse((theaterFromCOA.theaterTelNum !== '') ? theaterFromCOA.theaterTelNum : '0312345678', 'JP');
        // tslint:disable-next-line:no-single-line-block-comment
        /* istanbul ignore if */
        if (!phoneUtil.isValidNumber(phoneNumber)) {
            throw new Error('Invalid phone number format.');
        }
        formatedPhoneNumber = phoneUtil.format(phoneNumber, google_libphonenumber_1.PhoneNumberFormat.E164);
    }
    catch (error) {
        // tslint:disable-next-line:no-single-line-block-comment
        /* istanbul ignore next */
        throw new Error(`電話番号フォーマット時に問題が発生しました:${error.message}`);
    }
    return {
        id: '',
        screenCount: screensFromCOA.length,
        branchCode: theaterFromCOA.theaterCode,
        name: {
            ja: theaterFromCOA.theaterName,
            en: theaterFromCOA.theaterNameEng
        },
        kanaName: theaterFromCOA.theaterNameKana,
        containsPlace: screensFromCOA.map((screenFromCOA) => {
            return createScreeningRoomFromCOA(screenFromCOA);
        }),
        typeOf: factory.placeType.MovieTheater,
        telephone: formatedPhoneNumber
    };
}
exports.createMovieTheaterFromCOA = createMovieTheaterFromCOA;
/**
 * コアスクリーン抽出結果から上映室を作成する
 */
// tslint:disable-next-line:no-single-line-block-comment
/* istanbul ignore next */
function createScreeningRoomFromCOA(screenFromCOA) {
    const sections = [];
    const sectionCodes = [];
    screenFromCOA.listSeat.forEach((seat) => {
        if (sectionCodes.indexOf(seat.seatSection) &lt; 0) {
            sectionCodes.push(seat.seatSection);
            sections.push({
                branchCode: seat.seatSection,
                name: {
                    ja: `セクション${seat.seatSection}`,
                    en: `section${seat.seatSection}`
                },
                containsPlace: [],
                typeOf: factory.placeType.ScreeningRoomSection
            });
        }
        sections[sectionCodes.indexOf(seat.seatSection)].containsPlace.push({
            branchCode: seat.seatNum,
            typeOf: factory.placeType.Seat
        });
    });
    return {
        containsPlace: sections,
        branchCode: screenFromCOA.screenCode,
        name: {
            ja: screenFromCOA.screenName,
            en: screenFromCOA.screenNameEng
        },
        typeOf: factory.placeType.ScreeningRoom,
        maximumAttendeeCapacity: sections[0].containsPlace.length
    };
}
exports.createScreeningRoomFromCOA = createScreeningRoomFromCOA;
</pre>
    </article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>


    <div class="modal fade" id="searchResults">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Search results</h4>
          </div>
          <div class="modal-body"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div>


<footer>


<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a>
	
		on Thu Apr 11th 2019
	
	using the <a href="https://github.com/docstrap/docstrap">DocStrap template</a>.
</span>
</footer>

<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/toc.js"></script>

    <script type="text/javascript" src="scripts/fulltext-search-ui.js"></script>


<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( ".tutorial-section pre, .readme-section pre, pre.prettyprint.source" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			var langClassMatch = example.parent()[0].className.match(/lang\-(\S+)/);
			lang = langClassMatch ? langClassMatch[1] : "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );

	$.catchAnchorLinks( {
        navbarOffset: 10
	} );
	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			return $( heading ).attr( "id" ) || ( prefix + i );
		},
		selectors   : "#toc-content h1,#toc-content h2,#toc-content h3,#toc-content h4",
		showAndHide : false,
		smoothScrolling: true
	} );

	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();

    $( "table" ).each( function () {
      var $this = $( this );
      $this.addClass('table');
    } );

} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->



    <script type="text/javascript">
        $(document).ready(function() {
            SearcherDisplay.init();
        });
    </script>


</body>
</html>
